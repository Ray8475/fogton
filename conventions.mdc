# Соглашение по разработке (Conventions)

Правила для code-ассистента при генерации кода. **Источник правды** — [vision.md](vision.md); здесь только краткие принципы и ссылки, без дублирования.

---

## 1. Общий принцип

- **KISS:** максимально простое решение для MVP; без оверинжиниринга. Сначала корректность (балансы, учёт операций), потом усложнение.
- Любая архитектурная или технологическая деталь — в [vision.md](vision.md); код должен ему соответствовать.
- Все согласованные правки в коде ассистент выполняет сам, без перекладывания изменений на пользователя.

---

## 2. Стек и структура

- **Стек:** см. [vision.md — Технологии](vision.md). Python 3.12, FastAPI (API), aiogram (бот), SQLite + SQLAlchemy 2, HTML + Tailwind + vanilla JS (webapp). Без React/Vue, без GraphQL, без брокера очередей на MVP.
- **Структура:** monorepo: `backend/`, `bot/`, `webapp/`. Два процесса: API и бот; см. [vision.md — Структура проекта, Архитектура](vision.md).
- **API:** REST + JSON, простые эндпоинты; см. [vision.md — API стиль](vision.md).

---

## 3. Модель данных и БД

- **Модель данных:** единственная спецификация — раздел «Модель данных» и «Фиксация модели данных» в [vision.md](vision.md). Код (модели SQLAlchemy, миграции, API-контракты) должен строго соответствовать.
- Денежные и торговые величины — **Decimal**, не float. `ledger_entries` — источник правды для аудита; балансы обновлять транзакционно из ledger.

---

## 4. Конфигурация

- **Только переменные окружения** (env); см. [vision.md — Конфигурирование](vision.md). Список переменных и областей — там же и в `.env.example`. Не вводить конфиг-файлы (yaml/json) на MVP.
- Секреты не коммитить и не логировать.

---

## 5. Логирование

- **Формат и содержание логов:** единственная спецификация — раздел «Формат ведения логов» в [vision.md](vision.md). Одна запись — один JSON-объект в одну строку (NDJSON); обязательные поля `timestamp`, `level`, `service`, `event`, `message`; опциональные — по таблице событий. Вывод — stdout.
- Не логировать секреты, полный initData, лишние персональные данные; см. подраздел «Чего не журналируем» в [vision.md](vision.md).

---

## 6. Качество кода

- Имена: понятные, в стиле проекта (snake_case в Python). Типы и контракты — явно (type hints, Pydantic где уместно).
- Ошибки и граничные случаи: обрабатывать по сценариям из [vision.md — Бизнес-сценарии](vision.md) (альтернативы и ошибки); не глотать исключения без логирования.
- Тесты и API: ориентироваться на бизнес-сценарии и модель данных из [vision.md](vision.md); не дублировать в коде то, что уже задано в vision.

---

## 7. Чего не делать

- Не добавлять технологии и инфраструктуру, не описанные в vision (очереди, кэш, отдельные сервисы, GraphQL, и т.п.).
- Не дублировать в коде описание форматов и правил, которые полностью заданы в vision.md — ссылаться на документ или выносить в константы/комментарии со ссылкой на раздел vision.
