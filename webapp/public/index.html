<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gifts Futures MVP</title>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin />
    <link rel="preconnect" href="https://telegram.org" crossorigin />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg-color: var(--tg-theme-bg-color, #0f172a);
        --text-color: var(--tg-theme-text-color, #f1f5f9);
        --hint-color: var(--tg-theme-hint-color, #94a3b8);
        --secondary-bg-color: var(--tg-theme-secondary-bg-color, #1e293b);
        --button-color: var(--tg-theme-button-color, #3b82f6);
        --button-text-color: var(--tg-theme-button-text-color, #ffffff);
        --link-color: var(--tg-theme-link-color, #60a5fa);
        --header-bg-color: var(--tg-theme-header-bg-color, #1e293b);
      }
      html, body {
        background: var(--bg-color) !important;
        color: var(--text-color) !important;
        min-height: 100%;
      }
      .tg-card {
        background: var(--secondary-bg-color) !important;
        color: var(--text-color) !important;
      }
      .tg-text { color: var(--text-color) !important; }
      .tg-hint { color: var(--hint-color) !important; }
      .tg-btn {
        background: var(--button-color) !important;
        color: var(--button-text-color) !important;
      }
      .tg-input {
        background: var(--bg-color) !important;
        border-color: var(--header-bg-color) !important;
        color: var(--text-color) !important;
      }
      .loading-spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto 1rem;
        border: 3px solid var(--header-bg-color);
        border-top-color: var(--button-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .loading-card {
        background: var(--secondary-bg-color) !important;
        border-radius: 1.25rem;
        padding: 2rem 1.5rem;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 18rem;
        width: 100%;
      }
      .nav-tab.active {
        color: var(--button-color);
      }
      .nav-tab.active img {
        opacity: 1;
      }
      .nav-tab:not(.active) img {
        opacity: 0.65;
      }
    </style>
  </head>
  <body>
    <!-- Предупреждение, если открыто не в Telegram -->
    <div id="notInTelegram" class="min-h-screen flex items-center justify-center hidden tg-text">
      <div class="max-w-xs w-full rounded-2xl px-6 py-5 space-y-3 text-center tg-card">
        <img src="https://telegram.org/img/t_logo.png" alt="Telegram" class="w-20 h-20 mx-auto block">
        <div class="text-sm font-semibold tg-text">Упс!</div>
        <div class="text-xs tg-hint">
          Это приложение должно быть запущено <strong>внутри Telegram!</strong>
        </div>
        <div class="text-xs tg-hint">Откройте Mini App через кнопку в боте.</div>
      </div>
    </div>

    <!-- Экран загрузки -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center p-4">
      <div class="loading-card">
        <div id="loadingSpinner" class="loading-spinner" aria-hidden="true"></div>
        <h1 class="text-lg font-semibold tg-text mb-1">Gifts Futures</h1>
        <p class="text-sm tg-hint mb-3" id="status">Загрузка…</p>
        <button id="btnRetry" type="button" class="hidden rounded-lg px-4 py-2 text-sm font-medium tg-btn">Повторить</button>
      </div>
    </div>

    <!-- Основной экран после успешной авторизации -->
    <div id="appRoot" class="max-w-xl mx-auto p-4 pb-20 space-y-4 hidden">
      <!-- Главная -->
      <div id="sectionHome" class="app-section space-y-4">
        <div class="rounded-xl p-4 tg-card flex flex-col gap-2">
          <div class="flex items-center justify-between gap-2">
            <h1 class="text-xl font-semibold tg-text">Gifts Futures</h1>
            <button id="btnRefreshData" type="button" class="rounded-lg px-3 py-1.5 text-xs tg-btn shrink-0">Обновить</button>
          </div>
        </div>
        <div class="rounded-xl p-4 space-y-3 tg-card">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold tg-text">Рынки</h2>
            <span id="marketsBadge" class="text-[11px] px-2 py-0.5 rounded-full hidden tg-hint" style="background: var(--header-bg-color);"></span>
          </div>
          <div id="markets" class="text-sm space-y-2 tg-text">
            <div class="text-xs tg-hint">Загрузка...</div>
          </div>
        </div>
      </div>

      <!-- Профиль -->
      <div id="sectionProfile" class="app-section hidden">
        <div class="rounded-xl p-4 space-y-3 tg-card">
          <h2 class="font-semibold tg-text">Профиль</h2>
          <div id="profile" class="text-sm space-y-1 tg-text">
            <div class="text-xs tg-hint">Загрузка...</div>
          </div>
        </div>
      </div>

      <!-- Кошелёк -->
      <div id="sectionWallet" class="app-section hidden">
        <div class="rounded-xl p-4 space-y-3 tg-card">
          <h2 class="font-semibold tg-text">Кошелёк</h2>
          <div id="balances" class="text-sm space-y-1 tg-text">
            <div class="text-xs tg-hint">Загрузка...</div>
          </div>
        </div>
        <div class="rounded-xl p-4 space-y-3 tg-card mt-4">
          <h2 class="font-semibold tg-text">Пополнить</h2>
          <p class="text-xs tg-hint">Переведите TON или USDT на адрес проекта с указанным комментарием.</p>
          <div id="depositInstruction" class="text-sm space-y-2 tg-text">
            <div class="text-xs tg-hint">Загрузка...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Нижняя навигация -->
    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 hidden max-w-xl mx-auto border-t tg-card" style="border-color: var(--header-bg-color);">
      <div class="flex">
        <button type="button" data-tab="home" class="nav-tab flex-1 py-3 flex flex-col items-center justify-center gap-0.5 hover:opacity-90 transition-opacity" aria-label="Главная">
          <img src="images/home.png" alt="" class="w-6 h-6 object-contain" />
        </button>
        <button type="button" data-tab="profile" class="nav-tab flex-1 py-3 flex flex-col items-center justify-center gap-0.5 hover:opacity-90 transition-opacity" aria-label="Профиль">
          <img src="images/profile.png" alt="" class="w-6 h-6 object-contain" />
        </button>
        <button type="button" data-tab="wallet" class="nav-tab flex-1 py-3 flex flex-col items-center justify-center gap-0.5 hover:opacity-90 transition-opacity" aria-label="Кошелёк">
          <img src="images/wallet.png" alt="" class="w-6 h-6 object-contain" />
        </button>
      </div>
    </nav>

    <script>
      const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
      const API_BASE = isLocal ? "http://127.0.0.1:8000" : "https://api.fogton.ru";

      const loadingScreen = document.getElementById("loadingScreen");
      const appRoot = document.getElementById("appRoot");
      const notInTelegram = document.getElementById("notInTelegram");
      const bottomNav = document.getElementById("bottomNav");
      
      const tg = window.Telegram?.WebApp;
      
      if (!tg || !tg.initDataUnsafe?.user) {
        loadingScreen.classList.add("hidden");
        appRoot.classList.add("hidden");
        notInTelegram.classList.remove("hidden");
        throw new Error("Mini App должен быть открыт внутри Telegram");
      }
      
      tg.ready();
      tg.expand();

      function showTab(tabId) {
        document.querySelectorAll(".app-section").forEach((el) => el.classList.add("hidden"));
        document.querySelectorAll(".nav-tab").forEach((el) => el.classList.remove("active"));
        const section = document.getElementById("section" + (tabId === "home" ? "Home" : tabId === "profile" ? "Profile" : "Wallet"));
        const btn = document.querySelector('.nav-tab[data-tab="' + tabId + '"]');
        if (section) section.classList.remove("hidden");
        if (btn) btn.classList.add("active");
      }

      document.querySelectorAll(".nav-tab").forEach((btn) => {
        btn.addEventListener("click", () => showTab(btn.getAttribute("data-tab")));
      });
      showTab("home");

      let token = null;

      const API_RETRIES = 4;
      const API_RETRY_DELAY_MS = 2000;

      async function api(path, opts = {}) {
        const { timeoutMs: _tm, ...fetchOpts } = opts;
        const headers = Object.assign({}, fetchOpts.headers || {});
        if (token) headers["Authorization"] = `Bearer ${token}`;
        if (opts.json) {
          headers["Content-Type"] = "application/json";
          fetchOpts.body = JSON.stringify(opts.json);
        }
        const url = `${API_BASE}${path}`;
        let lastError = null;
        for (let attempt = 1; attempt <= API_RETRIES; attempt++) {
          try {
            const res = await fetch(url, { ...fetchOpts, headers });
            const txt = await res.text();
            let data;
            try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
            if (!res.ok) {
              lastError = new Error(data.detail || `HTTP ${res.status}`);
              if (res.status === 401 && path !== "/auth/telegram" && tg?.initData && !opts._retriedSession) {
                try {
                  const authRes = await fetch(`${API_BASE}/auth/telegram`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ init_data: tg.initData }),
                  });
                  if (authRes.ok) {
                    const authData = await authRes.json();
                    token = authData.token;
                    return api(path, { ...opts, _retriedSession: true });
                  }
                } catch (_) {}
              }
              if (res.status >= 500 && attempt < API_RETRIES) {
                await new Promise((r) => setTimeout(r, API_RETRY_DELAY_MS));
                continue;
              }
              if (res.status === 401) lastError = new Error("Сессия истекла. Откройте приложение снова.");
              throw lastError;
            }
            return data;
          } catch (e) {
            lastError = e;
            const isRetryable = e.message === "Failed to fetch" ||
                                e.message.includes("NetworkError") ||
                                e.message.includes("Load failed") ||
                                e.name === "TypeError" ||
                                e.name === "NetworkError";
            if (isRetryable && attempt < API_RETRIES) {
              await new Promise((r) => setTimeout(r, API_RETRY_DELAY_MS));
              continue;
            }
            throw e;
          }
        }
        throw lastError;
      }

      function renderProfile(me) {
        const el = document.getElementById("profile");
        el.innerHTML = "";
        const rows = [
          ["Внутренний ID", me.id],
          ["Telegram user_id", me.telegram_user_id],
        ];
        rows.forEach(([label, value]) => {
          const row = document.createElement("div");
          row.className = "flex justify-between items-center gap-4";
          row.innerHTML = `<span class="text-xs tg-hint">${label}</span><span class="text-sm font-medium tg-text">${value}</span>`;
          el.appendChild(row);
        });
      }

      function renderBalances(balances) {
        const el = document.getElementById("balances");
        el.innerHTML = "";
        if (!balances || !Array.isArray(balances.balances) || balances.balances.length === 0) {
          const empty = document.createElement("div");
          empty.className = "text-xs tg-hint";
          empty.textContent = "Пока нет балансов.";
          el.appendChild(empty);
          return;
        }
        balances.balances.forEach((b) => {
          const row = document.createElement("div");
          row.className = "flex justify-between items-center gap-4";
          row.innerHTML = `<span class="text-sm font-medium tg-text">${b.currency}</span><span class="text-sm tabular-nums tg-text">${b.available}</span>`;
          el.appendChild(row);
        });
      }

      function renderMarkets(markets) {
        const listEl = document.getElementById("markets");
        const badgeEl = document.getElementById("marketsBadge");
        listEl.innerHTML = "";

        const items = Array.isArray(markets) ? markets : markets?.markets || [];

        if (!items.length) {
          badgeEl.classList.add("hidden");
          const empty = document.createElement("div");
          empty.className = "text-xs tg-hint";
          empty.textContent = "Маркетов пока нет (MVP-заглушка).";
          listEl.appendChild(empty);
          return;
        }

        badgeEl.textContent = `${items.length} ${items.length === 1 ? "рынок" : "рынков"}`;
        badgeEl.style.background = "var(--header-bg-color)";
        badgeEl.classList.remove("hidden");

        items.forEach((m) => {
          const card = document.createElement("div");
          card.className = "rounded-lg px-3 py-2 space-y-1 tg-text";
          card.style.background = "var(--bg-color)";
          card.style.border = "1px solid var(--header-bg-color)";

          const title = document.createElement("div");
          title.className = "flex items-center justify-between gap-2";
          const activeBadge = m.active === false ?
            `<span class="text-[11px] px-2 py-0.5 rounded-full tg-hint" style="background: var(--header-bg-color);">неактивен</span>` :
            `<span class="text-[11px] px-2 py-0.5 rounded-full" style="background: rgba(16, 185, 129, 0.2); color: rgb(110, 231, 183);">активен</span>`;
          title.innerHTML = `<span class="font-medium tg-text">${m.gift || m.name || m.symbol || "Маркет"}</span>${activeBadge}`;

          const meta = document.createElement("div");
          meta.className = "text-[11px] tg-hint";
          const base = m.base || m.base_currency || "";
          const quote = m.quote || m.quote_currency || "";
          const expiryDays = m.expiry_days != null ? m.expiry_days : "";
          meta.textContent = base && quote ? `${base}/${quote}` : (expiryDays !== "" ? `Экспирация: ${expiryDays} дн.` : (m.description || ""));

          card.appendChild(title);
          card.appendChild(meta);
          listEl.appendChild(card);
        });
      }

      function setSectionError(elId, message) {
        const el = document.getElementById(elId);
        if (el) {
          el.innerHTML = `<div class="text-xs tg-hint">Ошибка загрузки: ${message}</div>`;
        }
      }

      function renderDepositInstruction(data) {
        const el = document.getElementById("depositInstruction");
        if (!el) return;
        const address = (data && data.address) || "";
        const comment = (data && data.comment) || "";
        if (!address) {
          el.innerHTML = "<div class=\"text-xs tg-hint\">Адрес пополнения не настроен.</div>";
          return;
        }
        el.innerHTML = "";
        const addrRow = document.createElement("div");
        addrRow.className = "space-y-1";
        addrRow.innerHTML = "<span class=\"text-xs tg-hint\">Адрес:</span>";
        const addrPre = document.createElement("div");
        addrPre.className = "break-all text-xs font-mono tg-text py-1 px-2 rounded-lg";
        addrPre.style.background = "var(--bg-color)";
        addrPre.textContent = address;
        const addrBtn = document.createElement("button");
        addrBtn.type = "button";
        addrBtn.className = "mt-1 rounded-lg px-3 py-1 text-xs tg-btn";
        addrBtn.textContent = "Копировать адрес";
        addrBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(address).then(() => { addrBtn.textContent = "Скопировано"; setTimeout(() => { addrBtn.textContent = "Копировать адрес"; }, 1500); });
        });
        addrRow.appendChild(addrPre);
        addrRow.appendChild(addrBtn);
        el.appendChild(addrRow);

        const commentRow = document.createElement("div");
        commentRow.className = "space-y-1 mt-3";
        commentRow.innerHTML = "<span class=\"text-xs tg-hint\">Комментарий (обязательно):</span>";
        const commentPre = document.createElement("div");
        commentPre.className = "break-all text-xs font-mono tg-text py-1 px-2 rounded-lg";
        commentPre.style.background = "var(--bg-color)";
        commentPre.textContent = comment;
        const commentBtn = document.createElement("button");
        commentBtn.type = "button";
        commentBtn.className = "mt-1 rounded-lg px-3 py-1 text-xs tg-btn";
        commentBtn.textContent = "Копировать комментарий";
        commentBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(comment).then(() => { commentBtn.textContent = "Скопировано"; setTimeout(() => { commentBtn.textContent = "Копировать комментарий"; }, 1500); });
        });
        commentRow.appendChild(commentPre);
        commentRow.appendChild(commentBtn);
        el.appendChild(commentRow);
      }

      async function loadData() {
        const profileEl = document.getElementById("profile");
        const balancesEl = document.getElementById("balances");
        const marketsEl = document.getElementById("markets");
        const depositEl = document.getElementById("depositInstruction");

        const [meResult, balancesResult, marketsResult, depositResult] = await Promise.allSettled([
          api("/me"),
          api("/me/balances"),
          api("/markets"),
          api("/me/deposit-instruction"),
        ]);

        if (meResult.status === "fulfilled") {
          renderProfile(meResult.value);
        } else if (profileEl) {
          setSectionError("profile", meResult.reason?.message || "Не удалось загрузить");
        }
        if (balancesResult.status === "fulfilled") {
          renderBalances(balancesResult.value);
        } else if (balancesEl) {
          setSectionError("balances", balancesResult.reason?.message || "Не удалось загрузить");
        }
        if (marketsResult.status === "fulfilled") {
          renderMarkets(marketsResult.value);
        } else if (marketsEl) {
          setSectionError("markets", marketsResult.reason?.message || "Не удалось загрузить");
        }
        if (depositResult.status === "fulfilled") {
          renderDepositInstruction(depositResult.value);
        } else if (depositEl) {
          setSectionError("depositInstruction", depositResult.reason?.message || "Не удалось загрузить");
        }
      }

      async function autoAuth() {
        const statusEl = document.getElementById("status");
        try {
          if (!tg || !tg.initDataUnsafe?.user) {
            throw new Error("Mini App должен быть открыт внутри Telegram");
          }
          
          const initData = tg.initData;
          if (!initData) throw new Error("initData пустой.");

          statusEl.textContent = "Загрузка…";
          const out = await api("/auth/telegram", { method: "POST", json: { init_data: initData } });
          token = out.token;
          
          loadingScreen.classList.add("hidden");
          appRoot.classList.remove("hidden");
          bottomNav.classList.remove("hidden");

          loadData();
        } catch (e) {
          const msg = e.message === "Failed to fetch" || e.name === "TypeError"
            ? "Нет связи с сервером. Проверьте интернет и попробуйте снова."
            : `Ошибка: ${e.message}`;
          statusEl.textContent = msg;
          statusEl.classList.add("tg-hint");
          document.getElementById("loadingSpinner").classList.add("hidden");
          document.getElementById("btnRetry").classList.remove("hidden");
          console.error("[autoAuth] Error:", e);
        }
      }

      document.getElementById("btnRefreshData").addEventListener("click", () => {
        const profileEl = document.getElementById("profile");
        const balancesEl = document.getElementById("balances");
        const marketsEl = document.getElementById("markets");
        const depositEl = document.getElementById("depositInstruction");
        if (profileEl) profileEl.innerHTML = "<div class=\"text-xs tg-hint\">Загрузка…</div>";
        if (balancesEl) balancesEl.innerHTML = "<div class=\"text-xs tg-hint\">Загрузка…</div>";
        if (marketsEl) marketsEl.innerHTML = "<div class=\"text-xs tg-hint\">Загрузка…</div>";
        if (depositEl) depositEl.innerHTML = "<div class=\"text-xs tg-hint\">Загрузка…</div>";
        loadData();
      });

      document.getElementById("btnRetry").addEventListener("click", () => {
        const statusEl = document.getElementById("status");
        const spinner = document.getElementById("loadingSpinner");
        const btnRetry = document.getElementById("btnRetry");
        statusEl.textContent = "Загрузка…";
        statusEl.classList.remove("tg-hint");
        spinner.classList.remove("hidden");
        btnRetry.classList.add("hidden");
        autoAuth();
      });

      window.addEventListener("load", () => {
        autoAuth();
      });
    </script>
  </body>
</html>

