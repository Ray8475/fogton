<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gifts Futures MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <!-- Экран загрузки -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
      <div class="max-w-xs w-full rounded-2xl bg-slate-900 border border-slate-800 px-6 py-5 space-y-3 text-center">
        <div class="text-sm font-semibold text-slate-200">Gifts Futures (MVP)</div>
        <div class="text-xs text-slate-400">
          Авторизация через Telegram WebApp initData → JWT.
        </div>
        <div class="text-sm text-slate-300" id="status">Запуск Mini App…</div>
      </div>
    </div>

    <!-- Основной экран после успешной авторизации -->
    <div id="appRoot" class="max-w-xl mx-auto p-4 space-y-4 hidden">
      <div class="rounded-xl bg-slate-900 p-4 border border-slate-800">
        <h1 class="text-xl font-semibold">Gifts Futures (MVP)</h1>
        <p class="text-slate-300 text-sm">Авторизация выполнена, данные загружены с API.</p>
      </div>

      <div class="rounded-xl bg-slate-900 p-4 border border-slate-800 space-y-3">
        <h2 class="font-semibold">Профиль</h2>
        <div id="profile" class="text-sm text-slate-200 space-y-1"></div>
      </div>

      <div class="rounded-xl bg-slate-900 p-4 border border-slate-800 space-y-3">
        <h2 class="font-semibold">Баланс</h2>
        <div id="balances" class="text-sm text-slate-200 space-y-1"></div>
      </div>

      <div class="rounded-xl bg-slate-900 p-4 border border-slate-800 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Рынки</h2>
          <span id="marketsBadge" class="text-[11px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-300 hidden"></span>
        </div>
        <div id="markets" class="text-sm text-slate-200 space-y-2"></div>
      </div>

      <div class="rounded-xl bg-slate-900 p-4 border border-slate-800 space-y-3 text-xs text-slate-400">
        <div class="font-semibold text-slate-300">Настройки API (для отладки)</div>
        <div class="space-y-2">
          <div><span class="font-medium text-slate-200">API:</span> <span id="apiBase"></span></div>
          <div class="flex gap-2">
            <input id="apiInput" class="flex-1 rounded-lg bg-slate-950 border border-slate-800 px-3 py-1 text-xs text-slate-100" placeholder="https://api.fogton.ru" />
            <button id="btnSaveApi" class="rounded-lg bg-slate-800 hover:bg-slate-700 px-3 py-1 text-xs">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(location.search);
      const apiFromQuery = params.get("api");
      const apiFromStorage = localStorage.getItem("apiBase");
      // Автоматическое определение: если локальная разработка (localhost/127.0.0.1), используем локальный API
      const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
      const defaultApi = isLocal ? "http://127.0.0.1:8000" : "https://api.fogton.ru";
      let API_BASE = apiFromQuery || apiFromStorage || defaultApi;

      const apiBaseEl = document.getElementById("apiBase");
      const apiInputEl = document.getElementById("apiInput");
      const loadingScreen = document.getElementById("loadingScreen");
      const appRoot = document.getElementById("appRoot");
      apiBaseEl.textContent = API_BASE;
      apiInputEl.value = API_BASE;

      document.getElementById("btnSaveApi").addEventListener("click", () => {
        const v = (apiInputEl.value || "").trim();
        if (!v) return;
        API_BASE = v;
        localStorage.setItem("apiBase", v);
        apiBaseEl.textContent = v;
      });

      let token = null;

      async function api(path, opts = {}) {
        const headers = Object.assign({}, opts.headers || {});
        if (token) headers["Authorization"] = `Bearer ${token}`;
        if (opts.json) {
          headers["Content-Type"] = "application/json";
          opts.body = JSON.stringify(opts.json);
        }
        const res = await fetch(`${API_BASE}${path}`, { ...opts, headers });
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
        return data;
      }

      function renderProfile(me) {
        const el = document.getElementById("profile");
        el.innerHTML = "";
        const rows = [
          ["Внутренний ID", me.id],
          ["Telegram user_id", me.telegram_user_id],
        ];
        rows.forEach(([label, value]) => {
          const row = document.createElement("div");
          row.className = "flex justify-between items-center gap-4";
          row.innerHTML = `<span class="text-slate-400 text-xs">${label}</span><span class="text-slate-100 text-sm font-medium">${value}</span>`;
          el.appendChild(row);
        });
      }

      function renderBalances(balances) {
        const el = document.getElementById("balances");
        el.innerHTML = "";
        if (!balances || !Array.isArray(balances.balances) || balances.balances.length === 0) {
          const empty = document.createElement("div");
          empty.className = "text-xs text-slate-400";
          empty.textContent = "Пока нет балансов.";
          el.appendChild(empty);
          return;
        }
        balances.balances.forEach((b) => {
          const row = document.createElement("div");
          row.className = "flex justify-between items-center gap-4";
          row.innerHTML = `<span class="text-slate-300 text-sm font-medium">${b.currency}</span><span class="text-slate-100 text-sm tabular-nums">${b.available}</span>`;
          el.appendChild(row);
        });
      }

      function renderMarkets(markets) {
        const listEl = document.getElementById("markets");
        const badgeEl = document.getElementById("marketsBadge");
        listEl.innerHTML = "";

        const items = Array.isArray(markets) ? markets : markets?.markets || [];

        if (!items.length) {
          badgeEl.classList.add("hidden");
          const empty = document.createElement("div");
          empty.className = "text-xs text-slate-400";
          empty.textContent = "Маркетов пока нет (MVP-заглушка).";
          listEl.appendChild(empty);
          return;
        }

        badgeEl.textContent = `${items.length} ${items.length === 1 ? "рынок" : "рынков"}`;
        badgeEl.classList.remove("hidden");

        items.forEach((m) => {
          const card = document.createElement("div");
          card.className = "rounded-lg border border-slate-800 bg-slate-950/40 px-3 py-2 space-y-1";

          const title = document.createElement("div");
          title.className = "flex items-center justify-between gap-2";
          title.innerHTML = `<span class="font-medium text-slate-100">${m.name || m.symbol || "Маркет"}</span>
            <span class="text-[11px] px-2 py-0.5 rounded-full ${
              m.active === false ? "bg-slate-800 text-slate-400" : "bg-emerald-900/60 text-emerald-300"
            }">${m.active === false ? "неактивен" : "активен"}</span>`;

          const meta = document.createElement("div");
          meta.className = "text-[11px] text-slate-400";
          const base = m.base || m.base_currency || "";
          const quote = m.quote || m.quote_currency || "";
          meta.textContent = base && quote ? `${base}/${quote}` : m.description || "";

          card.appendChild(title);
          card.appendChild(meta);
          listEl.appendChild(card);
        });
      }

      async function loadData() {
        const me = await api("/me");
        renderProfile(me);

        const balances = await api("/me/balances");
        renderBalances(balances);

        const markets = await api("/markets");
        renderMarkets(markets);
      }

      async function autoAuth() {
        const statusEl = document.getElementById("status");
        try {
          const tg = window.Telegram?.WebApp;
          if (!tg) throw new Error("Открой Mini App внутри Telegram.");
          tg.ready();
          const initData = tg.initData;
          if (!initData) throw new Error("initData пустой.");

          statusEl.textContent = "Авторизация через Telegram…";
          const out = await api("/auth/telegram", { method: "POST", json: { init_data: initData } });
          token = out.token;
          statusEl.textContent = `Авторизация успешна, user_id=${out.user.id}`;
          await loadData();

          // показываем основной экран
          loadingScreen.classList.add("hidden");
          appRoot.classList.remove("hidden");
        } catch (e) {
          statusEl.textContent = `Ошибка авторизации: ${e.message}`;
        }
      }

      window.addEventListener("load", () => {
        autoAuth();
      });
    </script>
  </body>
</html>

