<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gifts Futures MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg-color: var(--tg-theme-bg-color, #0f172a);
        --text-color: var(--tg-theme-text-color, #f1f5f9);
        --hint-color: var(--tg-theme-hint-color, #94a3b8);
        --secondary-bg-color: var(--tg-theme-secondary-bg-color, #1e293b);
        --button-color: var(--tg-theme-button-color, #3b82f6);
        --button-text-color: var(--tg-theme-button-text-color, #ffffff);
        --link-color: var(--tg-theme-link-color, #60a5fa);
        --header-bg-color: var(--tg-theme-header-bg-color, #1e293b);
      }
      body {
        background: var(--bg-color);
        color: var(--text-color);
      }
    </style>
  </head>
  <body>
    <!-- Предупреждение, если открыто не в Telegram -->
    <div id="notInTelegram" class="min-h-screen flex items-center justify-center hidden" style="background: var(--bg-color); color: var(--text-color);">
      <div class="max-w-xs w-full rounded-2xl px-6 py-5 space-y-3 text-center" style="background: var(--secondary-bg-color);">
        <img src="https://telegram.org/img/t_logo.png" alt="Telegram" style="width: 80px; height: 80px; margin: 0 auto;">
        <div class="text-sm font-semibold" style="color: var(--text-color);">Упс!</div>
        <div class="text-xs" style="color: var(--hint-color);">
          Это приложение должно быть запущено <strong>внутри Telegram!</strong>
        </div>
        <div class="text-xs" style="color: var(--hint-color);">
          Откройте Mini App через кнопку в боте.
        </div>
      </div>
    </div>

    <!-- Экран загрузки -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center" style="background: var(--bg-color);">
      <div class="max-w-xs w-full rounded-2xl px-6 py-5 space-y-3 text-center" style="background: var(--secondary-bg-color);">
        <div class="text-sm font-semibold" style="color: var(--text-color);">Gifts Futures (MVP)</div>
        <div class="text-xs" style="color: var(--hint-color);">
          Авторизация через Telegram WebApp initData → JWT.
        </div>
        <div class="text-sm" id="status" style="color: var(--text-color);">Запуск Mini App…</div>
      </div>
    </div>

    <!-- Основной экран после успешной авторизации -->
    <div id="appRoot" class="max-w-xl mx-auto p-4 space-y-4 hidden" style="background: var(--bg-color);">
      <div class="rounded-xl p-4" style="background: var(--secondary-bg-color);">
        <h1 class="text-xl font-semibold" style="color: var(--text-color);">Gifts Futures (MVP)</h1>
        <p class="text-sm" style="color: var(--hint-color);">Авторизация выполнена, данные загружены с API.</p>
      </div>

      <div class="rounded-xl p-4 space-y-3" style="background: var(--secondary-bg-color);">
        <h2 class="font-semibold" style="color: var(--text-color);">Профиль</h2>
        <div id="profile" class="text-sm space-y-1" style="color: var(--text-color);">
          <div class="text-xs" style="color: var(--hint-color);">Загрузка...</div>
        </div>
      </div>

      <div class="rounded-xl p-4 space-y-3" style="background: var(--secondary-bg-color);">
        <h2 class="font-semibold" style="color: var(--text-color);">Баланс</h2>
        <div id="balances" class="text-sm space-y-1" style="color: var(--text-color);">
          <div class="text-xs" style="color: var(--hint-color);">Загрузка...</div>
        </div>
      </div>

      <div class="rounded-xl p-4 space-y-3" style="background: var(--secondary-bg-color);">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold" style="color: var(--text-color);">Рынки</h2>
          <span id="marketsBadge" class="text-[11px] px-2 py-0.5 rounded-full hidden" style="background: var(--header-bg-color); color: var(--hint-color);"></span>
        </div>
        <div id="markets" class="text-sm space-y-2" style="color: var(--text-color);">
          <div class="text-xs" style="color: var(--hint-color);">Загрузка...</div>
        </div>
      </div>

      <div class="rounded-xl p-4 space-y-3 text-xs" style="background: var(--secondary-bg-color); color: var(--hint-color);">
        <div class="font-semibold" style="color: var(--text-color);">Настройки API (для отладки)</div>
        <div class="space-y-2">
          <div><span class="font-medium" style="color: var(--text-color);">API:</span> <span id="apiBase" style="color: var(--text-color);"></span></div>
          <div class="flex gap-2">
            <input id="apiInput" class="flex-1 rounded-lg px-3 py-1 text-xs" style="background: var(--bg-color); border: 1px solid var(--header-bg-color); color: var(--text-color);" placeholder="https://api.fogton.ru" />
            <button id="btnSaveApi" class="rounded-lg px-3 py-1 text-xs" style="background: var(--button-color); color: var(--button-text-color);">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(location.search);
      const apiFromQuery = params.get("api");
      const apiFromStorage = localStorage.getItem("apiBase");
      // Автоматическое определение: если локальная разработка (localhost/127.0.0.1), используем локальный API
      const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
      const defaultApi = isLocal ? "http://127.0.0.1:8000" : "https://api.fogton.ru";
      let API_BASE = apiFromQuery || apiFromStorage || defaultApi;

      const apiBaseEl = document.getElementById("apiBase");
      const apiInputEl = document.getElementById("apiInput");
      const loadingScreen = document.getElementById("loadingScreen");
      const appRoot = document.getElementById("appRoot");
      const notInTelegram = document.getElementById("notInTelegram");
      
      const tg = window.Telegram?.WebApp;
      
      if (!tg || !tg.initDataUnsafe?.user) {
        loadingScreen.classList.add("hidden");
        appRoot.classList.add("hidden");
        notInTelegram.classList.remove("hidden");
        throw new Error("Mini App должен быть открыт внутри Telegram");
      }
      
      tg.ready();
      tg.expand();
      
      apiBaseEl.textContent = API_BASE;
      apiInputEl.value = API_BASE;

      document.getElementById("btnSaveApi").addEventListener("click", () => {
        const v = (apiInputEl.value || "").trim();
        if (!v) return;
        API_BASE = v;
        localStorage.setItem("apiBase", v);
        apiBaseEl.textContent = v;
      });

      let token = null;

      const API_RETRIES = 3;
      const API_RETRY_DELAY_MS = 600;

      async function api(path, opts = {}) {
        const headers = Object.assign({}, opts.headers || {});
        if (token) headers["Authorization"] = `Bearer ${token}`;
        if (opts.json) {
          headers["Content-Type"] = "application/json";
          opts.body = JSON.stringify(opts.json);
        }
        const url = `${API_BASE}${path}`;
        let lastError = null;
        for (let attempt = 1; attempt <= API_RETRIES; attempt++) {
          try {
            const res = await fetch(url, { ...opts, headers });
            const txt = await res.text();
            let data;
            try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
            if (!res.ok) {
              lastError = new Error(data.detail || `HTTP ${res.status}`);
              if (res.status >= 500 && attempt < API_RETRIES) {
                await new Promise((r) => setTimeout(r, API_RETRY_DELAY_MS));
                continue;
              }
              throw lastError;
            }
            return data;
          } catch (e) {
            lastError = e;
            const isRetryable = e.message === "Failed to fetch" || 
                                e.message.includes("NetworkError") || 
                                e.message.includes("Load failed") ||
                                e.name === "TypeError" ||
                                e.name === "NetworkError";
            if (isRetryable && attempt < API_RETRIES) {
              await new Promise((r) => setTimeout(r, API_RETRY_DELAY_MS));
              continue;
            }
            throw e;
          }
        }
        throw lastError;
      }

      function renderProfile(me) {
        const el = document.getElementById("profile");
        el.innerHTML = "";
        const rows = [
          ["Внутренний ID", me.id],
          ["Telegram user_id", me.telegram_user_id],
        ];
        rows.forEach(([label, value]) => {
          const row = document.createElement("div");
          row.className = "flex justify-between items-center gap-4";
          row.innerHTML = `<span class="text-xs" style="color: var(--hint-color);">${label}</span><span class="text-sm font-medium" style="color: var(--text-color);">${value}</span>`;
          el.appendChild(row);
        });
      }

      function renderBalances(balances) {
        const el = document.getElementById("balances");
        el.innerHTML = "";
        if (!balances || !Array.isArray(balances.balances) || balances.balances.length === 0) {
          const empty = document.createElement("div");
          empty.className = "text-xs";
          empty.style.color = "var(--hint-color)";
          empty.textContent = "Пока нет балансов.";
          el.appendChild(empty);
          return;
        }
        balances.balances.forEach((b) => {
          const row = document.createElement("div");
          row.className = "flex justify-between items-center gap-4";
          row.innerHTML = `<span class="text-sm font-medium" style="color: var(--text-color);">${b.currency}</span><span class="text-sm tabular-nums" style="color: var(--text-color);">${b.available}</span>`;
          el.appendChild(row);
        });
      }

      function renderMarkets(markets) {
        const listEl = document.getElementById("markets");
        const badgeEl = document.getElementById("marketsBadge");
        listEl.innerHTML = "";

        const items = Array.isArray(markets) ? markets : markets?.markets || [];

        if (!items.length) {
          badgeEl.classList.add("hidden");
          const empty = document.createElement("div");
          empty.className = "text-xs";
          empty.style.color = "var(--hint-color)";
          empty.textContent = "Маркетов пока нет (MVP-заглушка).";
          listEl.appendChild(empty);
          return;
        }

        badgeEl.textContent = `${items.length} ${items.length === 1 ? "рынок" : "рынков"}`;
        badgeEl.style.background = "var(--header-bg-color)";
        badgeEl.style.color = "var(--hint-color)";
        badgeEl.classList.remove("hidden");

        items.forEach((m) => {
          const card = document.createElement("div");
          card.className = "rounded-lg px-3 py-2 space-y-1";
          card.style.background = "var(--bg-color)";
          card.style.border = "1px solid var(--header-bg-color)";

          const title = document.createElement("div");
          title.className = "flex items-center justify-between gap-2";
          const activeBadge = m.active === false ? 
            `<span class="text-[11px] px-2 py-0.5 rounded-full" style="background: var(--header-bg-color); color: var(--hint-color);">неактивен</span>` :
            `<span class="text-[11px] px-2 py-0.5 rounded-full" style="background: rgba(16, 185, 129, 0.2); color: rgb(110, 231, 183);">активен</span>`;
          title.innerHTML = `<span class="font-medium" style="color: var(--text-color);">${m.name || m.symbol || "Маркет"}</span>${activeBadge}`;

          const meta = document.createElement("div");
          meta.className = "text-[11px]";
          meta.style.color = "var(--hint-color)";
          const base = m.base || m.base_currency || "";
          const quote = m.quote || m.quote_currency || "";
          meta.textContent = base && quote ? `${base}/${quote}` : m.description || "";

          card.appendChild(title);
          card.appendChild(meta);
          listEl.appendChild(card);
        });
      }

      function setSectionError(elId, message) {
        const el = document.getElementById(elId);
        if (el) {
          el.innerHTML = `<div class="text-xs" style="color: var(--hint-color);">Ошибка загрузки: ${message}</div>`;
        }
      }

      async function loadData() {
        const profileEl = document.getElementById("profile");
        const balancesEl = document.getElementById("balances");
        const marketsEl = document.getElementById("markets");

        try {
          const me = await api("/me");
          renderProfile(me);
        } catch (e) {
          const msg = e.message || "Не удалось загрузить";
          if (profileEl) setSectionError("profile", msg);
        }

        try {
          const balances = await api("/me/balances");
          renderBalances(balances);
        } catch (e) {
          const msg = e.message || "Не удалось загрузить";
          if (balancesEl) setSectionError("balances", msg);
        }

        try {
          const markets = await api("/markets");
          renderMarkets(markets);
        } catch (e) {
          const msg = e.message || "Не удалось загрузить";
          if (marketsEl) setSectionError("markets", msg);
        }
      }

      async function autoAuth() {
        const statusEl = document.getElementById("status");
        try {
          if (!tg || !tg.initDataUnsafe?.user) {
            throw new Error("Mini App должен быть открыт внутри Telegram");
          }
          
          const initData = tg.initData;
          if (!initData) throw new Error("initData пустой.");

          statusEl.textContent = "Авторизация через Telegram…";
          const out = await api("/auth/telegram", { method: "POST", json: { init_data: initData } });
          token = out.token;
          
          loadingScreen.classList.add("hidden");
          appRoot.classList.remove("hidden");
          
          await new Promise((r) => setTimeout(r, 300));
          
          try {
            await loadData();
          } catch (e) {
            console.error("[autoAuth] loadData failed:", e);
          }
        } catch (e) {
          statusEl.textContent = `Ошибка авторизации: ${e.message}`;
          statusEl.style.color = "var(--hint-color)";
          console.error("[autoAuth] Error:", e);
        }
      }

      window.addEventListener("load", () => {
        autoAuth();
      });
    </script>
  </body>
</html>

